# Portfolio Application - Kubernetes Deployment

Complete Kubernetes (k3s) deployment for the Portfolio application with PostgreSQL read replica and load-balanced image service.

## üöÄ Quick Start
```bash
# 1. Build and import images to k3s (no registry needed)
./build-and-import-k3s.sh

# 2. Deploy everything
./deploy-k3s-local.sh

# 3. Create admin user
kubectl exec -n portfolio deployment/backend -- \
  python -m scripts.admin.create_admin

# 4. Access application
kubectl get svc nginx -n portfolio
# Visit http://<NODE-IP>:<NODEPORT>
```

## üì¶ Local Image Workflow

This deployment uses **local images** imported directly into k3s - no external registry required.

### Images Used
- **Custom (built locally):**
  - `portfolio-postgres:latest` - Custom Postgres with SSL & pg_cron
  - `portfolio-backend:latest` - FastAPI application
  - `portfolio-image-service:latest` - Image processing service
  - `portfolio-nginx:latest` - Web server + frontend
  
- **Public (pulled automatically):**
  - `redis:7-alpine`
  - `minio/minio:latest`

## üìÅ Files Structure

```
.
‚îú‚îÄ‚îÄ DEPLOYMENT-GUIDE.md       # Detailed deployment instructions
‚îú‚îÄ‚îÄ ARCHITECTURE.md            # System architecture and scaling
‚îú‚îÄ‚îÄ deploy.sh                  # Automated deployment script
‚îú‚îÄ‚îÄ cleanup.sh                 # Remove all resources
‚îú‚îÄ‚îÄ k8s/                       # Kubernetes manifests
‚îÇ   ‚îú‚îÄ‚îÄ 00-namespace.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 01-configmap.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 02-secrets.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 03-pvcs.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 04-postgres-primary.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 05-postgres-replica.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 06-redis.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 07-minio.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 08-image-service.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 09-backend.yaml
‚îÇ   ‚îî‚îÄ‚îÄ 10-nginx.yaml
‚îî‚îÄ‚îÄ .credentials               # Generated secrets (git-ignored)
```

## ‚öôÔ∏è Configuration

### Before Deployment

1. **Build Docker Images**
   ```bash
   cd backend && docker build -t your-registry/backend:latest .
   cd image-service && docker build -t your-registry/image-service:latest .
   cd nginx && docker build -t your-registry/nginx:latest .
   ```

2. **Push to Registry**
   ```bash
   docker push your-registry/backend:latest
   docker push your-registry/image-service:latest
   docker push your-registry/nginx:latest
   ```

3. **Update Image References** in k8s manifests:
   - `k8s/08-image-service.yaml` (line 32)
   - `k8s/09-backend.yaml` (lines 39, 67)
   - `k8s/10-nginx.yaml` (line 186)

4. **Configure Secrets** in `k8s/02-secrets.yaml` or use the deploy script

### Environment Variables

Key configurations in `k8s/01-configmap.yaml`:
- `POSTGRES_DB`: Database name
- `MINIO_BUCKET`: Object storage bucket
- `IMAGE_SERVICE_URL`: Image service endpoint
- `ALLOWED_ORIGINS`: CORS origins

Secrets in `k8s/02-secrets.yaml` (or generated by deploy.sh):
- `POSTGRES_PASSWORD`: Database password
- `SECRET_KEY`: JWT signing key
- `ADMIN_API_KEY`: Admin bypass key
- `MINIO_ROOT_PASSWORD`: MinIO password
- `RESEND_API_KEY`: Email service API key

## üèóÔ∏è Architecture

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇLoad Balancer‚îÇ
                    ‚îÇ   (nginx)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                  ‚îÇ                  ‚îÇ
        ‚ñº                  ‚ñº                  ‚ñº
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇBackend ‚îÇ      ‚îÇImage Service‚îÇ    ‚îÇ  Static  ‚îÇ
   ‚îÇ  (2x)  ‚îÇ      ‚îÇ    (2x)     ‚îÇ    ‚îÇ  Files   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                  ‚îÇ
       ‚îÇ                  ‚îÇ
       ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ   ‚îÇ  MinIO   ‚îÇ
‚îÇ   Primary    ‚îÇ   ‚îÇ   (1x)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ replication
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL  ‚îÇ   ‚îÇ  Redis   ‚îÇ
‚îÇ   Replica    ‚îÇ   ‚îÇ   (1x)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  (reads only)
```

### Components

- **Nginx (1x)**: Reverse proxy, static file serving, load balancing
- **Backend (2x)**: FastAPI application, API endpoints
- **Image Service (2x)**: Image processing, NSFW detection, storage
- **PostgreSQL Primary (1x)**: Write database, replication master
- **PostgreSQL Replica (1x)**: Read-only database replica
- **Redis (1x)**: Cache layer, rate limiting
- **MinIO (1x)**: S3-compatible object storage

### Resource Requirements

- **Minimum**: 2 CPU cores, 5GB RAM, 50GB disk
- **Recommended**: 4 CPU cores, 8GB RAM, 100GB disk

## üîÑ Common Operations

### Scaling

```bash
# Scale backend to 5 replicas
kubectl scale deployment backend -n portfolio --replicas=5

# Scale image service to 3 replicas
kubectl scale deployment image-service -n portfolio --replicas=3

# Check current scaling
kubectl get deployments -n portfolio
```

### Monitoring

```bash
# View all pods
kubectl get pods -n portfolio

# Check pod logs
kubectl logs -n portfolio deployment/backend -f
kubectl logs -n portfolio deployment/image-service -f

# Resource usage
kubectl top pods -n portfolio
kubectl top nodes

# Check events
kubectl get events -n portfolio --sort-by='.lastTimestamp'
```

### Database Operations

```bash
# Connect to primary (writes)
kubectl exec -it -n portfolio postgres-primary-0 -- \
  psql -U postgres -d portfolio

# Connect to replica (reads)
kubectl exec -it -n portfolio postgres-replica-0 -- \
  psql -U postgres -d portfolio

# Check replication status
kubectl exec -n portfolio postgres-primary-0 -- \
  psql -U postgres -d portfolio -c \
  "SELECT * FROM pg_stat_replication;"

# Verify replica is in recovery mode
kubectl exec -n portfolio postgres-replica-0 -- \
  psql -U postgres -d postgres -c \
  "SELECT pg_is_in_recovery();"
```

### Updating Application

```bash
# Build new image
docker build -t your-registry/backend:v2 ./backend
docker push your-registry/backend:v2

# Update deployment
kubectl set image deployment/backend backend=your-registry/backend:v2 -n portfolio

# Monitor rollout
kubectl rollout status deployment/backend -n portfolio

# Rollback if needed
kubectl rollout undo deployment/backend -n portfolio
```

### Backup & Restore

```bash
# Backup database
kubectl exec -n portfolio postgres-primary-0 -- \
  pg_dump -U postgres portfolio > backup.sql

# Restore database
cat backup.sql | kubectl exec -i -n portfolio postgres-primary-0 -- \
  psql -U postgres portfolio
```

## üîí Security

### ‚ö†Ô∏è CRITICAL: Production Security Checklist

1. **Remove Admin Bypass Logic**
   ```
   Before production deployment, remove the admin bypass logic from:
   backend/app/auth/csrf.py (lines 75-130)
   
   This bypass allows CSRF token circumvention and must NOT be present in production!
   ```

2. **Generate Strong Secrets**
   ```bash
   # Generate secure passwords
   openssl rand -base64 32
   ```

3. **Enable HTTPS**
   - Install cert-manager
   - Configure Let's Encrypt
   - Update nginx with TLS

4. **Network Policies**
   - Restrict pod-to-pod communication
   - Only allow necessary ports

5. **Update Secrets**
   - Change default `MINIO_ROOT_USER` and `MINIO_ROOT_PASSWORD`
   - Set real `RESEND_API_KEY` for email
   - Update `API_BASE_URL` to your domain

## üêõ Troubleshooting

### Pods Not Starting

```bash
# Check pod status
kubectl describe pod -n portfolio <pod-name>

# View logs
kubectl logs -n portfolio <pod-name>

# Check events
kubectl get events -n portfolio --sort-by='.lastTimestamp'
```

### Database Connection Issues

```bash
# Test connectivity from backend
kubectl exec -n portfolio deployment/backend -- \
  pg_isready -h postgres-primary -U postgres

# Check database logs
kubectl logs -n portfolio postgres-primary-0
```

### Replica Not Syncing

```bash
# Check replication status
kubectl exec -n portfolio postgres-primary-0 -- \
  psql -U postgres -d portfolio -c \
  "SELECT * FROM pg_stat_replication;"

# Reinitialize replica
kubectl delete pod -n portfolio postgres-replica-0
# It will automatically recreate and re-sync
```

### Image Service Issues

```bash
# Check MinIO connectivity
kubectl exec -n portfolio deployment/image-service -- \
  curl http://minio:9000/minio/health/live

# Check NSFW model status
kubectl logs -n portfolio deployment/image-service | grep nsfw
```

## üìä Performance Tuning

### Database
- Increase `shared_buffers` for better caching
- Tune `work_mem` for complex queries
- Enable query statistics: `pg_stat_statements`

### Backend
- Increase worker processes: `--workers 4`
- Tune connection pool: `DB_POOL_MAX_SIZE=50`
- Enable aggressive caching

### Load Balancing
- Use session affinity for sticky sessions if needed
- Configure upstream keepalive
- Enable HTTP/2

## üßπ Cleanup

```bash
# Remove everything (including data)
./cleanup.sh

# Or manually
kubectl delete namespace portfolio
```

## üìö Additional Documentation

- [DEPLOYMENT-GUIDE.md](DEPLOYMENT-GUIDE.md) - Step-by-step deployment
- [ARCHITECTURE.md](ARCHITECTURE.md) - Detailed architecture diagrams
- Backend API docs: `http://<loadbalancer-ip>/docs`

## ü§ù Support

For issues or questions:
1. Check logs: `kubectl logs -n portfolio <pod-name>`
2. Review events: `kubectl get events -n portfolio`
3. Check resource usage: `kubectl top pods -n portfolio`

## üìù License

[Your License Here]

## ‚≠ê Features

‚úÖ PostgreSQL Primary + Replica for read scaling
‚úÖ 2x Image Service replicas with automatic load balancing
‚úÖ 2x Backend replicas with rolling updates
‚úÖ Persistent storage for all stateful services
‚úÖ SSL/TLS for PostgreSQL connections
‚úÖ Health checks and auto-restart
‚úÖ Resource limits and requests
‚úÖ NSFW content detection
‚úÖ Redis caching layer
‚úÖ Automated migrations on deployment